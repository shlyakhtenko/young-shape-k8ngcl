"use strict";(self.webpackChunkreact=self.webpackChunkreact||[]).push([[837],{3837:(e,l,a)=>{a.r(l),a.d(l,{default:()=>h});var n=a(2791),i=a(1282);function t(e){return[{name:"inputs",caption:"Input Column",query:e.name,fields:Object.entries(e.fields).map((e=>{let[l,a]=e;return{name:l,caption:a.caption,editable:a.editable,primary_key:a.primary_key,edit_type:a.edit_type,edit:!1,criteria:[],display_on_card:null,type:a.type}}))}]}function s(e,l,a){return{name:l,caption:a,query:e.name,fields:Object.entries(e.fields).map((e=>{let[l,a]=e;return{name:l,caption:a.caption,editable:a.editable,edit:!1,criteria:[],type:a.type,display_on_card:!0}}))}}function r(e,l,a,n){let i=[...new Set(l.map((e=>e.fields)).flat().filter((e=>e.edit)))].map((e=>e.name));console.log("compute_output: wip_fields = ",i,"query=",e);let t={name:a,caption:n,query:e.name,fields:Object.entries(e.fields).map((e=>{let[l,a]=e;return i.includes(l)||a.primary_key?{name:l,caption:a.caption,editable:a.editable,edit:!1,criteria:[],type:a.type,display_on_card:!0}:null})).filter((e=>null!=e))};return console.log("compute_outputs returning",t),t}var c=a(3360),d=a(184);const o=function(e){const l=e.siblings,a=e.setter,i=e.column_data,[t,s]=(0,n.useState)(e.local_fields?Object.keys(e.local_fields).length:0),r=3+Object.entries(i.fields).map((e=>{let[,l]=e;return l.criteria.length})).reduce(((e,l)=>Math.max(e,l)),-1/0);return(0,d.jsxs)("div",{className:"column",children:[(0,d.jsxs)("label",{children:["Column:",(0,d.jsx)("input",{value:i.caption,onChange:e=>{let n=l.map((l=>l.name==i.name?{...i,caption:e.target.value}:l));a(n)}},"column_name")]}),(0,d.jsxs)("div",{children:[(0,d.jsxs)("table",{className:"fieldTable",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{children:"Field"}),e.use_field?(0,d.jsx)("th",{children:"Display?"}):"",e.edit_field?(0,d.jsx)("th",{children:"Edit?"}):"",console.log("numColumns=",r),Array.apply(null,new Array(r-2)).map(((e,l)=>(console.log("i=",l),(0,d.jsx)("th",{children:0==l?"Criteria":"...or..."},l))))]})}),(0,d.jsxs)("tbody",{children:[Object.entries(i.fields).map((n=>{let[,t]=n;return(0,d.jsxs)("tr",{children:[(0,d.jsx)("td",{children:t.caption}),e.use_field?(0,d.jsx)("td",{children:(0,d.jsx)("input",{type:"checkbox",checked:t.display_on_card,onChange:e=>{let n=Object.entries(i.fields).map((l=>{let[,a]=l;return a.name==t.name?{...t,display_on_card:e.target.checked}:a})),s=l.map((e=>e.name==i.name?{...i,fields:n}:e));a(s)}},i.name+"_"+t.name+"_use")}):"",e.edit_field?(0,d.jsx)("td",{children:(0,d.jsx)("input",{type:"checkbox",checked:t.edit?1:0,disabled:!t.editable||t.primary_key,onChange:n=>{let s=Object.entries(i.fields).map((e=>{let[,l]=e;return l.name==t.name?{...t,edit:n.target.checked}:l})),r=l.map((e=>e.name==i.name?{...i,fields:s}:e));a(r),e.output_setter([])}},i.name+"_"+t.name+"_edit")}):"",[...t.criteria,[]].map(((e,n)=>(0,d.jsx)("td",{children:(0,d.jsx)("input",{onChange:e=>{let s=null;n!=Object.entries(t.criteria).length?s=Object.entries(i.fields).map((l=>{let[,a]=l;return a.name==t.name?{...t,criteria:t.criteria.map(((l,a)=>a!=n?l:[{op:e.target.value}]))}:a})):(console.log("got new criteria"),s=Object.entries(i.fields).map((l=>{let[,a]=l;return{...a,criteria:[...a.criteria,a.name==t.name?[{op:e.target.value}]:""]}}))),console.log("n=",n,s);let r=l.map((e=>e.name==i.name?{...i,fields:s}:e));console.log(r),a(r)},value:e[0]?e[0].op:""})},n)))]},"tr_"+t.name)})),(0,d.jsx)(d.Fragment,{children:e.local_fields?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("tr",{children:(0,d.jsx)("th",{className:"break",colSpan:r})}),(0,d.jsx)("tr",{children:(0,d.jsx)("th",{colSpan:r,className:"local_fields",children:(0,d.jsx)("h5",{children:(0,d.jsx)("b",{children:"Pipeline-only fields (not saved to PITS)"})})})}),(0,d.jsxs)("tr",{children:[(0,d.jsx)("th",{children:"Field"}),(0,d.jsx)("th",{children:"Field Type"}),(0,d.jsx)("th",{})]}),Object.entries(e.local_fields).map((l=>{let[a,n]=l;return(0,d.jsxs)("tr",{children:[(0,d.jsx)("td",{children:(0,d.jsx)("input",{value:n.caption,className:"local_field_input",placeholder:"Field Name",onChange:l=>{var a,t;a=n.name,t=l.target.value,e.setter(e.siblings.map((e=>e.name==i.name?{...e,local_fields:{...e.local_fields,[a]:{...e.local_fields[a],caption:t}}}:e)))}})}),(0,d.jsx)("td",{children:(0,d.jsxs)("select",{value:n.edit_type,onChange:l=>{return a=n.name,t=l.target.value,void e.setter(e.siblings.map((e=>e.name==i.name?{...e,local_fields:{...e.local_fields,[a]:{...e.local_fields[a],edit_type:t}}}:e)));var a,t},children:[(0,d.jsx)("option",{value:"string",children:"Short text or Number"}),(0,d.jsx)("option",{value:"textarea",children:"Long text"}),(0,d.jsx)("option",{value:"select_yesno",children:"Yes/No"})]})}),(0,d.jsx)("td",{colSpan:r-2,children:(0,d.jsx)(c.Z,{variant:"warning",size:"sm",onClick:()=>{e.setter(e.siblings.map((e=>{return e.name==i.name?{...e,local_fields:(l=n.name,a=e.local_fields,delete a[l],a)}:e;var l,a})))},children:"Delete"})})]},a)})),(0,d.jsx)("tr",{children:(0,d.jsx)("td",{colSpan:r,className:"local_fields_add_button",children:(0,d.jsx)(c.Z,{onClick:()=>{console.log("add field","local_fields",e.local_fields,"siblings",e.siblings,"column name",i.name);let l=e.siblings.map((e=>e.name==i.name?{...e,local_fields:{...e.local_fields,["local_field"+t]:{caption:"",edit_type:"string",name:"local_field"+t,editable:!0,edit:!0}}}:e));s((e=>e+1)),console.log("siblings",e.siblings,"newsibligs",l),e.setter(e.siblings.map((l=>l.name==i.name?{...l,local_fields:{...l.local_fields,["local_field"+t+Object.entries(e.local_fields).length]:{caption:"",type:"string",name:"local_field"+t+Object.entries(e.local_fields).length,editable:!0,edit:!0}}}:l)))},children:"Add Field"})})})]}):null})]})]}),e.remove_button?(0,d.jsx)(c.Z,{onClick:()=>{let n=l.filter((l=>e.keep_column?(console.log("Datacolumn:","s.name=",l.name,"keep_column=",e.keep_column),l.name!=i.name||l.name==e.keep_column):l.name!=i.name));a(n)},children:"Delete Column"}):""]})]})};var u=a(2288),p=a(6638),m=a(7689);function h(e){let l=null;const a=(0,n.useContext)(i.O),[h,_]=(0,n.useState)([]),[j,x]=(0,n.useState)(null),[b,f]=(0,n.useState)([]),[g,v]=(0,n.useState)(null),[y,k]=(0,n.useState)([]),[C,S]=(0,n.useState)({}),[q,N]=(0,n.useState)([]),[w,O]=(0,n.useState)(!1),[Z,F]=(0,n.useState)([]),[A,D]=(0,n.useState)([]),[P,T]=(0,n.useState)(null);let I=null,E=null;if("new"!=e.pipeline){let e=(0,m.UO)();l=e.pipelineName,[I,E]=(0,n.useState)(l)}else l="Pipeline",[I,E]=(0,n.useState)("");const[G,L]=(0,n.useState)(l);return w||(()=>{const n="https://docs.ipam.ucla.edu/cocytus/get_data_sources.php?ipam_id="+a.ipam_id+"&session_token="+a.session_token;fetch(n,{mode:"cors",headers:{},method:"GET"}).then((a=>{a.json().then((a=>{console.log("pipeline_editor: got data",a);let n=null;"new"!=e.pipeline?(n=a.pipelines.find((e=>e.name==l)),console.log("pipeine editor: new_pipeline_data",n,"data.pipelines",a.pipelines,"looking for ",l)):n={name:"new",caption:"New Pipeline",data_source:a.data_sources[0].name,query:a.data_sources[0].available_queries[0].name,inputs:t(a.data_sources[0].available_queries[0]),local_fields:a.local_fields?a.local_fields:[]},T(n),_(a.data_sources);let i=a.data_sources.find((e=>e.name==n.data_source));console.log("new_data_source",i,"loaded=",w),x(i),S(i.available_queries.find((e=>e.name==n.inputs[0].query))),console.log("subqueries",i.available_queries[0],i.available_queries[0].available_sub_queries),D(i.available_queries.map((e=>({value:e.name,label:e.caption})))),f(i.available_queries[0].available_sub_queries?i.available_queries[0].available_sub_queries.map((e=>({value:e.name,label:e.caption}))):[]),v(null),k(n.inputs),"new"!=e.pipeline?(N(n.wips),F(n.outputs),L(n.caption)):(L(""),N([]),F([])),O(!0)}))}))})(),(0,d.jsxs)("div",{className:"App",children:[(0,d.jsx)("nav",{children:(0,d.jsxs)(u.Z,{className:"Breadcrumb",children:[(0,d.jsx)(u.Z.Item,{href:"/malebolge/",children:"Home"}),(0,d.jsxs)(u.Z.Item,{active:!0,children:["Editing pipeline: ",G]})]})}),(0,d.jsx)("h1",{children:"Pipeline Editor"}),j&&P?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("label",{className:"pipelineName",children:["Pipeline name:",(0,d.jsx)(p.Z.Control,{type:"text",value:G,onChange:e=>{L(e.target.value),E(encodeURIComponent(e.target.value))}})]}),(0,d.jsxs)("div",{className:"preamble",children:[(0,d.jsxs)("label",{children:["Datasource:",(0,d.jsx)(p.Z.Select,{className:"data_selector",defaultValue:j.name,onChange:e=>{let l=e.target.value,a=h.filter((e=>e.name==l))[0];x(a),k(t(a.available_queries[0])),N([]),F([]),D(a.available_queries.map((e=>({value:e.name,label:e.caption}))))},children:h.map((e=>(0,d.jsx)("option",{value:e.name,children:e.caption},e.name)))})]}),(0,d.jsxs)("label",{children:["Query:",(0,d.jsxs)(p.Z.Select,{className:"data_selector",defaultValue:C.name,onChange:e=>{let l=e.target.value,a=j.available_queries.filter((e=>e.name==l))[0];S(a),k(t(a)),f(a.available_sub_queries?a.available_sub_queries.map((e=>({value:e.name,label:e.caption}))):[]),console.log("set subqueries",a.available_sub_queries?a.available_sub_queries.map((e=>({value:e.name,label:e.caption}))):[]),N([]),F([])},children:[console.log(C),A.map((e=>(0,d.jsx)("option",{value:e.value,children:e.label},e.value)))]})]}),(0,d.jsxs)("label",{children:["Column:",(0,d.jsxs)(p.Z.Select,{className:"data_selector",default_value:"",onChange:e=>{let l=b.filter((l=>l.name==e.target.value))[0];v(l),F([])},children:[(0,d.jsx)("option",{value:null,children:"Entire output"}),b.map((e=>(0,d.jsx)("option",{value:e.value,children:e.label},e.name)))]})]})]}),(0,d.jsxs)("table",{className:"columntable",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[(0,d.jsxs)("th",{children:[(0,d.jsx)("h2",{children:"Inputs"}),(0,d.jsx)("h4",{children:"New cards appear here"})]}),(0,d.jsxs)("th",{children:[(0,d.jsxs)("h2",{children:["To-Do's"," ",(0,d.jsx)(c.Z,{onClick:()=>{N([...q,s(C,"wip"+q.length+1,"")])},children:"Add Column"})]}),(0,d.jsx)("h4",{children:"Cards you are working on appear here"})]}),(0,d.jsxs)("th",{children:[(0,d.jsxs)("h2",{children:["Done"," ",(0,d.jsx)(c.Z,{onClick:()=>{F([...Z,r(C,q,"outputs"+Z.length+1,"")])},children:"Add Column"})]}),(0,d.jsx)("h4",{children:"All cards should end up here"})]})]})}),(0,d.jsx)("tbody",{children:(0,d.jsxs)("tr",{children:[(0,d.jsx)("td",{children:(0,d.jsx)("div",{className:"columnset",children:(0,d.jsx)(o,{column_data:y[0],local_fields:y[0].local_fields?y[0].local_fields:{},siblings:y,setter:k,use_field:!0,edit_field:!1},"inputs")})}),(0,d.jsx)("td",{children:(0,d.jsx)("div",{className:"columnset",children:q.map((e=>(0,d.jsx)(o,{column_data:{...e,fields:e.fields},siblings:q,setter:N,remove_button:!0,output_setter:F,use_field:!1,edit_field:!0},e.name)))})}),(0,d.jsx)("td",{children:(0,d.jsx)("div",{className:"columnset",children:Z.map((e=>(0,d.jsx)(o,{column_data:e,siblings:Z,remove_button:!0,setter:F,use_field:!1,edit_field:!1},e.name)))})})]})})]}),(0,d.jsx)("hr",{}),(0,d.jsx)(c.Z,{disabled:0==Z.length||""==G,onClick:()=>{let e={data_source:j.name,query:C.name,sub_query:g.name,name:I,caption:G,inputs:y,wips:q,outputs:Z,local_fields:P.local_fields};const l={"Content-Type":"application/json"},n="https://docs.ipam.ucla.edu/cocytus/save_pipeline.php?ipam_id="+a.ipam_id+"&session_token="+a.session_token,i=JSON.stringify(e);console.log("saving pipline before fetch url=",n,"body=",i,"headers=",l),fetch(n,{headers:l,body:i,mode:"cors",method:"POST"}).then((e=>{e.text().then((e=>{alert("Saved. Got response: "+e)}))}))},children:"Save"}),(0,d.jsx)("hr",{})]}):(0,d.jsx)("div",{children:"Loading data sources..."})]})}}}]);
//# sourceMappingURL=837.fe699e2f.chunk.js.map